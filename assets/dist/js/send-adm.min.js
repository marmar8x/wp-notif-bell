!function(){"use strict";var e=jQuery,t=window.CM,n=WpnbAdm,a=marked,r=Quill,o=wpnb_data_obj,i=wpnb_texts,s=function(e){var t;return null!==(t=i[e])&&void 0!==t?t:""},d={res_name_str:"#wpnb_send_res_form_name_str",res_name_slc:"#wpnb_send_res_form_name_slc",res_data:"#wpnb_send_res_form_data",res_area:"#wpnb_receivers_area",res_add_btn:"#wpnb_res_add_btn",res_none_alert:"#wpnb_res_alert_none",send_btn:"#wpnb_act_send",notif_title:"#wpnb_send_title",notif_text:"#wpnb_send_text",notif_sender:"#wpnb_send_sender",notif_text_type:"#wpnb_send_text_type",notif_date:"#wpnb_send_date",notif_tags:"#wpnb_send_tags",notif_area:"#wpnb_send_area",edit_key:"#wpnb_edit_key",resp_area:"#wpnb_response_area",edit_url:"#wpnb_edit_url",preview_fr:"#wpnb_preview_frame",simple_editor:"#wpnb_simple_text",text_content:"#wpnb_text_content",quill_editor:"#wpnb_quill_editor",simple_editor_area:"#wpnb_simple_editor",mce_editor:"#wpnb_mce_editor",cm_md_ed:"#wpnb_ed_md_cm",cm_html_ed:"#wpnb_ed_html_cm",area_cm_md:"#wpnb_area_cm_md",area_code_ed:"#wpnb_code_editor",area_visual_ed:"#wpnb_visual_editor",raw_content:"#wpnb_raw_text_content"},l={res_loop:".wpnb-res-loop",res_close:".wpnb-tp-close",res_count:".wpnb-dt-res-count",tags_count:".wpnb-dt-tags-count",date_status:".wpnb-dt-date-st"},c=!1,_=function(e){alert(e)},u=function(){var t=e(l.res_loop),n=[];return t.each((function(e){var a={name:t.eq(e).data("wpnb-res-name"),data:t.eq(e).data("wpnb-res-data")};n.push(a)})),n},p=function(e){return!!/[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1]) (2[0-3]|[01][0-9]):[0-5][0-9]:[0-5][0-9]/.exec(e)},m=function(t,n){var a;void 0===n&&(n=!0),null===(a=e(d.res_name_slc).find('option[value="'+t+'"]'))||void 0===a||a.prop("selected",!0),n&&w(t)},f=function(t){e(d.res_data).attr("placeholder",t)},v=function(t){e(d.res_data).val(t)},w=function(t){var n,a=null===(n=e(d.res_name_slc).find('option[value="'+t+'"]'))||void 0===n?void 0:n.data("wpnb-text");f(a||"")};e(d.res_name_slc).on("change",(function(t){var n,a=e(t.target).find("option:selected").val();v(""),"user-role"===a?e(d.res_data).attr("list","wpnb_send_usr_roles"):e(d.res_data).removeAttr("list");var r=function(t){var n,a=null===(n=e(t.target).find("option:selected"))||void 0===n?void 0:n.data("wpnb-ez");return a?a.split(":",2):null}(t);null!==r&&(a=r[0],m(a),v(r[1])),"custom"===a&&(e(d.res_name_slc).hide(),e(d.res_name_str).fadeIn(),f((null===(n=e(t.target).find('option[value="custom"]'))||void 0===n?void 0:n.data("wpnb-text"))||"")),w(a)})),e(d.res_name_str).on("dblclick",(function(){e(d.res_name_slc).fadeIn(),e(d.res_name_str).hide(),m("user-id")})),e(d.res_name_str).on("change input",(function(){var t=e(d.res_name_str).val();e(d.res_name_str).val(n.slugify(t))})),e(d.notif_tags).on("change input",(function(){var t=e(d.notif_tags).val(),a=n.slugify(t,",").replace(/\,+/g,",");e(d.notif_tags).val(a);var r=a.split(","),o=0===(r=(r=r.filter((function(e){return""!==e}))).filter((function(e,t,n){return!t||e!=n[t-1]}))).length?"["+s("optional")+"]":"["+r.length+"]";e(l.tags_count).html(o)}));var b=function(t){var a=function(e,t){return'<div class="cell:100 cell-sm:50 cell-md:33 wpnb-res-loop" data-wpnb-res-id="'+e+'" data-wpnb-res-name="'+t.name+'" data-wpnb-res-data="'+t.data+'">\n        <div class="wpnb-ad-res-box">\n            <div class="wpnb-hide-more wpnb-w-100">\n                <span class="wpnb-tp-title">'+t.name+'</span>\n                <span class="wpnb-tp-text">\n                    '+t.data+'\n                </span>\n            </div>\n            \n            <span style="flex-grow: 1; text-align: end;">\n                <button class="wpnb-tp-close" data-wpnb-res-close-id="'+e+'">\n                    &times;\n                </button>\n            </span>\n        </div>\n    </div>'}(n.randomStr(12),t),r=null;""===t.name?r=s("err.res-name"):/^[a-zA-Z0-9-]+$/.test(t.name)||(r=s("err.res-name-fr")),""===t.data&&(r=s("err.res-data")),null===r?(e(d.res_area).append(a),e(d.res_data).val("")):_(r)};e(d.res_add_btn).on("click",(function(){var t=function(t){return"custom"===t?e(d.res_name_str).val():t}(e(d.res_name_slc).val()),n=e(d.res_data).val();(function(e,t){var n=u();for(var a of n)if(a.name==e&&a.data==t)return!0;return!1})(t,n)?_(s("err.res-name-dup")):b({name:t,data:n})}));e(d.res_area).on("DOMNodeInserted DOMNodeRemoved",(function(t){var n,a=t.type,r=t.target;if(e(r).hasClass(l.res_loop.slice(1))){e(r).find(l.res_close).on("click",(function(t){var n,a;n=e(t.target).data("wpnb-res-close-id"),null===(a=e('[data-wpnb-res-id="'+n+'"]'))||void 0===a||a.remove()}));var o=document.querySelectorAll(l.res_loop).length,i="DOMNodeInserted"===a?o:o-1;e(l.res_count).text(0===i?"":"("+i+")"),n=0===i,e(d.res_none_alert).toggle(n)}})),e(d.notif_date).on("input change",(function(t){var n=t.target;e(n).val(e(n).val().slice(0,19)),""===e(n).val()?e(l.date_status).html(s("emp-auto")):p(e(n).val())?e(l.date_status).html(""):e(l.date_status).html(s("incorrect"))})),e(d.notif_sender).on("input change",(function(t){e(t.target).val(n.slugify(e(t.target).val()))})),window.addEventListener("load",(function(){var t;m("user-id");var n=[d.notif_date,d.notif_sender,d.notif_tags],a=new Event("change");for(var r of n)null===(t=document.querySelector(r))||void 0===t||t.dispatchEvent(a);H(),function(){var t=e(d.res_area).data("wpnb-value");if(Array.isArray(t)&&0!==t.length)for(var n of t){var a={name:n.name,data:n.data};b(a)}}(),S(),E(),N(D()),window.setInterval((function(){H()}),5e3)}));var g="",h="",y="",x=null,k="simple",q=function(t){k=t,"simple"!==t?e(d.simple_editor_area).hide():e(d.simple_editor_area).show(),"html"===t?e(d.area_code_ed).show():e(d.area_code_ed).hide(),"markdown"===t?e(d.area_cm_md).show():e(d.area_cm_md).hide(),"quill"===t||"wp"===t?e(d.area_visual_ed).show():e(d.area_visual_ed).hide(),M()},S=function(){var t,n=e(d.text_content),a=C();if(h=n.data("wpnb-visual-editor"),g=n.data("wpnb-editor"),y=n.data("wpnb-editor-base"),"simple"!==g){if("visual"===y&&"quill"===h){x=new r(d.quill_editor,{theme:null!==(t=o.quill.theme)&&void 0!==t?t:"snow",modules:{toolbar:[["bold","italic","underline","strike"],["blockquote"],["link","image","video"],[{list:"ordered"},{list:"bullet"},{list:"check"}],[{size:["small",!1,"large","huge"]}],[{header:[1,2,3,4,5,6,!1]}],[{color:[]},{background:[]}],["clean"]]},placeholder:s("notif.text-pl")}),a&&x.setContents(a),"rtl"===o.dir&&(x.format("direction","rtl"),x.format("align","right")),k="quill"}O(a),"code"===y&&z(a)}else k="simple"},E=function(){if(e(d.simple_editor).on("change input",(function(){j(e(d.simple_editor).val())})),"auto"===g&&"visual"===y)if("quill"===h)x.on("text-change",(function(){j(x.root.innerHTML)}));else{var t=tinyMCE.get(d.mce_editor.slice(1));null==t||t.on("change",(function(e){var n=t.getContent().replace(/(&nbsp;)*/g,"");j(n)}))}},M=function(){var t,n=C();"simple"===k?e(d.simple_editor).val(n):"quill"===k?x.root.innerHTML=n:"wp"===k?null===(t=tinyMCE.get(d.mce_editor.slice(1)))||void 0===t||t.setContent(n):"markdown"===k?I.dispatch({changes:{from:0,to:I.state.doc.length,insert:n}}):"html"===k&&L.dispatch({changes:{from:0,to:L.state.doc.length,insert:n}})};e(d.text_content).on("change input",(function(e){H()})),e(d.notif_text_type).on("change",(function(e){H();var t=D();N(t)}));var N=function(e){q("auto"===g?"markdown"===e?"markdown":"html"===e?"code"===y?"html":"quill"===h?"quill":"wp":"simple":"simple")},j=function(t,n){var a,r;void 0===n&&(n=null),e(d.text_content).val(t),null===(a=document.querySelector(d.text_content))||void 0===a||a.dispatchEvent(new Event("change")),e(d.raw_content).val(null!==n?n:t),null===(r=document.querySelector(d.raw_content))||void 0===r||r.dispatchEvent(new Event("change"))},C=function(t){return void 0===t&&(t=!0),e(t?d.raw_content:d.text_content).val()},A=function(e){return e.replace(/<[^>]*>?/gm,"")},H=function(){var t=d.preview_fr,n=document.querySelector(t);if(n&&n.contentDocument){var r=D(),o=n.contentDocument,i=C();o.open(),"markdown"===r?i=a.parse(i):"text"===r?i=A(i).replace(/\n/g,"<br />"):"pure-text"===r&&(i=A(i)),"markdown"!==r&&"html"!==r||(i=filterXSS(i)),i=i.replace(/\[[a-zA-Z0-9\:\.\_\-]*\]/g,'<code style="color:red;">$&</code>'),o.writeln(i),o.close()}else e(t).hide()},D=function(){return e(d.notif_text_type).val()},I=null,L=null,O=function(e){var n=t["@codemirror/view"],a=n.EditorView,r=n.keymap,o=n.lineNumbers,i=n.placeholder;n.ViewUpdate;var l=t["@codemirror/state"].EditorState,c=t["@codemirror/commands"].defaultKeymap,_=t["@codemirror/language"],u=_.syntaxHighlighting,p=_.defaultHighlightStyle,m=_.bracketMatching,f=t["@codemirror/lang-markdown"].markdown;I=new a({state:l.create({doc:e,extensions:[r.of(c),o(),i(s("editor.md-pl")),m(),f(),u(p),a.updateListener.of((function(e){e.docChanged&&j(e.state.doc.toString())}))]}),parent:document.querySelector(d.cm_md_ed)})},z=function(e){var n=t["@codemirror/view"],a=n.EditorView,r=n.keymap,o=n.lineNumbers,i=n.placeholder,l=t["@codemirror/state"].EditorState,c=t["@codemirror/commands"].defaultKeymap,_=t["@codemirror/language"],u=_.syntaxHighlighting,p=_.defaultHighlightStyle,m=_.bracketMatching,f=t["@codemirror/lang-html"].html;L=new a({state:l.create({doc:e,extensions:[r.of(c),o(),i(s("editor.ht-pl")),m(),f(),u(p),a.updateListener.of((function(e){e.docChanged&&j(e.state.doc.toString())}))]}),parent:document.querySelector(d.cm_html_ed)})};e(d.send_btn).click((function(t){if(c)_(s("err.n-sending"));else{var n=e(t.target).data("wpnb-action"),a="send";n&&"edit"===n&&document.querySelector(d.edit_key)&&(a="edit"),c=!0;var r={sender:e(d.notif_sender).val(),title:e(d.notif_title).val(),text:C(!1),format:e(d.notif_text_type).val(),date:e(d.notif_date).val(),tags:e(d.notif_tags).val().split(",").filter((function(e){return""!==e})),receivers:u()},o=[];if(""===r.sender&&o.push(s("err.n-sender-req")),""===r.title&&o.push(s("err.n-title-req")),""===r.text&&o.push(s("err.n-text-req")),""===r.format&&o.push(s("err.n-format-req")),0===r.receivers.length&&o.push(s("err.n-res-req")),""===r.date||p(r.date)||o.push(s("err.n-date")),0===o.length)"send"===a?J(r):V(r),c=!1;else{c=!1;var i=o.map((function(e){return"- "+e})).join("\n");_(s("err.fix-msg")+"\n"+i)}}}));var T=function(t){var n=e(d.send_btn);t?n.removeAttr("disabled"):n.attr("disabled","disabled")},V=function(t){var n=o.ajax_url,a=o.security,r=e(d.edit_key).val();K(!1),T(!1),e.ajax({type:"post",dataType:"json",url:n,data:{notif:t,action:"wpnb_edit_notif",security:a,key:r},success:function(e){e.success?Q(e.data.status,e,e.data.errors,e.data.data):Q("None",e)},error:function(e){Q("Error",e)}}).done((function(){T(!0)}))},J=function(t){var n=o.ajax_url,a=o.security;K(!0),T(!1),e.ajax({type:"post",dataType:"json",url:n,data:{notif:t,action:"wpnb_send_notif",security:a},success:function(t){if(t.success)return"sent"===t.data.status&&function(){var t=[d.notif_title,d.notif_date,d.notif_sender,d.notif_text,d.notif_tags];for(var n of t)e(n).val("");e(d.notif_text_type).val(e(d.notif_text_type).find("option:first").val()),e(d.res_area).find(l.res_loop).remove(),j(""),M()}(),void Q(t.data.status,t,t.data.errors,t.data.data);Q("None",t)},error:function(e){Q("Error",e)}}).done((function(){T(!0)}))},K=function(t){var n=s(t?"msg.sending":"msg.updating");e(d.resp_area).html('\n        <div class="wpnb-msg-sent wpnb-w-100 wpnb-alert wpnb-alert-bg-primary wpnb-mt-4">\n            '+n+"\n        </div>\n    ")},Q=function(t,n,a,r){var o;void 0===n&&(n={}),void 0===a&&(a=[]),void 0===r&&(r=[]);var i=e(d.resp_area),l="edit"===e(d.send_btn).data("wpnb-action"),c="sent"===t||"updated"===t?"success":"danger",_="",u="";(_=s(l?"updated"===t?"res.updated":"res.update-f":"sent"===t?"res.sent":"res.send-f"),"sent"===t)&&(u+='\n            <a href="'+(null===(o=e(d.edit_url))||void 0===o?void 0:o.val().replace("{key}",r.key))+'">\n                '+s("btn.n-edit")+"\n            </a>\n        ");var p='\n        <div class="wpnb-msg-sent wpnb-w-100 wpnb-alert wpnb-alert-bg-'+c+' wpnb-mt-4">\n            '+_+"\n            "+u+"\n        </div>\n    ";p+="None"!==t?'\n            <div class="wpnb-msg-sent wpnb-w-100 wpnb-alert wpnb-alert-cl-black wpnb-mt-4">\n                '+s("su.result")+" "+t+" <br />\n                "+s("data")+" "+JSON.stringify(r)+" <br />\n                "+s("errors")+" "+JSON.stringify(a)+"\n            </div>\n        ":'\n            <div class="wpnb-msg-sent wpnb-w-100 wpnb-alert wpnb-alert-cl-black wpnb-mt-4">\n                '+s("err.code")+" "+n.data.error+" <br />\n                "+s("err.msg")+" "+n.data.msg+" <br />\n            </div>\n        ",i.html(p)}}();
//# sourceMappingURL=send-adm.min.js.map
